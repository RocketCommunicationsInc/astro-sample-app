<link rel="import" href="/bower_components/polymer/polymer.html">
<script src="//d3js.org/d3.v3.js"></script>


<dom-module id="rux-spectrum-analysis">
  <template>
    <style>
      :host {
        border: 1px solid red;
        height: 100vh;
        width: 200vw;
        display: block;

        contain: content;
      }

      #chart-container {
        outline: 1px solid green;
        height: 100px;
        width: 100%;
      }

      .chart {
        position: absolute;
        top: 0;
        left: 0;
      }

      .bar {
        fill: orange;
      }

      .bar:hover {
        fill: steelblue;
      }

      .axis text {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .x.axis path {
        display: none;
      }

      .test {
        border: 1px solid red;
      }
    </style>

    
    <!-- <svg id="chart" class="chart" height$="[[height]]" width$="[[width]]"></svg> -->
    

  </template>

  <script>
    class RuxSpectrumAnalysis extends Polymer.Element {
      static get is() { return 'rux-spectrum-analysis'; }
      static get properties() {
        return {
          chartData: {
            type: Object,
            observer: '_update'
          },
          chartLegend: {
            type: Object
          },
          height: {
            type: Number
          },
          width: {
            type: Number
          }
        }
      }

    constructor() {
      super();
    }



    connectedCallback() {
      super.connectedCallback();

      let margin = {top: 20, right: 30, bottom: 30, left: 40}
      let width = this.width - margin.left - margin.right
      let height = this.height - margin.top - margin.bottom;
      

      var xScale = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);
      

      var yScale = d3.scale.linear()
        .range([height, 0]);

      var xAxis = d3.svg.axis()
        .scale(xScale)
        .orient("bottom");

      var yAxis = d3.svg.axis()
        .scale(yScale)
        .orient("left")
        .ticks(10, "%");
        
        xScale.domain(this.chartLegend.xscale);
        yScale.domain(this.chartLegend.yscale);

        
      
      
      const svg = d3.select(this.root)
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("class", "chart");
        
      const chart = svg.append("g")
        .attr('class','graph')
        .attr("transform", `translate(${margin.left},${margin.top})`);

        chart.append("g")
          .attr("class", "x axis")
          .attr("transform", `translate(0,${height})`)
          .call(xAxis);

        chart.append("g")
          .attr("class", "y axis")
          .call(yAxis);

        // reference to the graph
        this.graph = d3.select(this.root.querySelector('.graph'));
    }

    disconnectedCallback() {
      super.disconnectedCallback();
    }

    ready() {
      super.ready();

    }


    _update() {
      this._clear();
      this._draw();
    }
 

    _clear() {
      this.graph.selectAll('.bar').remove();
    }




    _draw() {

      // Using a forEach loop to make use of lexical this, but
      // currently performance of forEach is substantially slower
      // than a standard for().
      this.chartData.forEach((data) => {
        this.graph.selectAll('.bar')
          .data(this.chartData)
          .enter()
          .append('rect')
            .attr('class','bar')
            .attr('x',      (data) => { return data.frequency; })
            .attr('y',      (data) => { return data.power; })
            .attr('height', (data) => { return this.height - data.power; })
            .attr('width', 10);


          // this is the original x/y/height data with the xScale/yScale applied
          // couldnâ€™t get thsoe functions to return.
          //
          // Side note, not knowing anything about d3, but rather than replacing
          // the bars is it possible to transition them?
          /*
          .attr("x", function(d) { return xScale(d.frequency); })
          .attr("y", function(d) { return yScale(d.power); })
          .attr("height", function(d) { return height - yScale(d.power); })
          */
      });
    }
  }

    customElements.define(RuxSpectrumAnalysis.is, RuxSpectrumAnalysis);

  </script>
  
</dom-module>
